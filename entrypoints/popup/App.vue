<template>
  <div class="popup-container">
    <div class="header">
      <h1>SyncParty</h1>
      <p class="subtitle">함께 보는 즐거움</p>
      <button class="settings-btn" @click="openSettings()" title="설정">
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.893 5.61302C11.9065 5.56224 11.937 5.51823 11.9742 5.48437C12.3094 5.44036 12.6513 5.41667 13 5.41667C13.3487 5.41667 13.6906 5.44036 14.0258 5.48437C14.063 5.51823 14.0901 5.56224 14.107 5.61302L14.5708 7.22786C14.6893 7.6375 14.9838 7.94219 15.3325 8.11146C15.5898 8.23333 15.8336 8.37552 16.0672 8.53463C16.3854 8.75469 16.8018 8.85625 17.2148 8.75469L18.8466 8.34844C18.8974 8.33489 18.9482 8.33828 18.9956 8.35521C19.1784 8.5888 19.3476 8.83594 19.5 9.09323L19.6456 9.34375C19.7878 9.59766 19.913 9.86172 20.0247 10.1326C20.0146 10.1833 19.9909 10.2307 19.9536 10.268L18.7823 11.4766C18.4878 11.7812 18.3693 12.1909 18.3997 12.5768C18.4099 12.7156 18.4167 12.8578 18.4167 13C18.4167 13.1422 18.4099 13.2844 18.3997 13.4232C18.3693 13.8091 18.4878 14.2187 18.7823 14.5234L19.9503 15.732C19.9875 15.7693 20.0112 15.8167 20.0213 15.8674C19.9096 16.1383 19.7844 16.4023 19.6422 16.6596L19.5 16.9068C19.3443 17.1641 19.175 17.4078 18.9956 17.6448C18.9482 17.6617 18.8974 17.6617 18.8466 17.6516L17.2148 17.2453C16.8018 17.1437 16.3888 17.2453 16.0672 17.4654C15.8336 17.6245 15.5898 17.7667 15.3325 17.8885C14.9838 18.0544 14.6859 18.3625 14.5708 18.7721L14.107 20.387C14.0935 20.4378 14.063 20.4818 14.0258 20.5156C13.6906 20.5596 13.3487 20.5833 13 20.5833C12.6513 20.5833 12.3094 20.5596 11.9742 20.5156C11.937 20.4818 11.9099 20.4378 11.893 20.387L11.4292 18.7721C11.3107 18.3625 11.0161 18.0578 10.6674 17.8885C10.4101 17.7667 10.1664 17.6245 9.9328 17.4654C9.61457 17.2453 9.19817 17.1437 8.78515 17.2453L7.15338 17.6516C7.1026 17.6651 7.05182 17.6617 7.00442 17.6448C6.82161 17.4078 6.65234 17.1641 6.49661 16.9068L6.35442 16.6596C6.21223 16.4057 6.08697 16.1417 5.97525 15.8674C5.98541 15.8167 6.00911 15.7693 6.04635 15.732L7.2177 14.5234C7.51223 14.2187 7.63072 13.8091 7.60025 13.4232C7.5901 13.2844 7.58333 13.1422 7.58333 13C7.58333 12.8578 7.5901 12.7156 7.60025 12.5768C7.63072 12.1909 7.51223 11.7812 7.2177 11.4766L6.04973 10.2646C6.01249 10.2273 5.98879 10.1799 5.97864 10.1292C6.09036 9.85833 6.21562 9.59427 6.3578 9.33698L6.49999 9.08984C6.65572 8.83255 6.82499 8.5888 7.0078 8.35182C7.0552 8.33489 7.10598 8.33489 7.15676 8.34505L8.78853 8.7513C9.20155 8.85286 9.61458 8.7513 9.93619 8.53125C10.1698 8.37213 10.4135 8.22995 10.6708 8.10807C11.0195 7.94219 11.3174 7.63411 11.4325 7.22448L11.8963 5.60963L11.893 5.61302ZM13 4.33333C12.5599 4.33333 12.1232 4.36719 11.7 4.43151C11.6424 4.44167 11.5849 4.45859 11.5307 4.48568C11.2091 4.65156 10.9586 4.94609 10.8536 5.3151L10.3898 6.92995C10.3695 7.00443 10.3052 7.08229 10.2003 7.13307C9.89218 7.27864 9.59765 7.4513 9.32004 7.64088C9.22525 7.70521 9.12369 7.72213 9.04921 7.70182L7.41744 7.29557C7.04843 7.20417 6.66926 7.27526 6.36458 7.46823C6.31379 7.4987 6.26978 7.53932 6.23254 7.58672C5.99218 7.88802 5.76874 8.20286 5.569 8.53463L5.56562 8.54479L5.41666 8.80208L5.41327 8.81224C5.23046 9.14401 5.06796 9.48594 4.92916 9.8414C4.90885 9.89557 4.8953 9.95312 4.89192 10.0107C4.87499 10.3763 5.00364 10.7419 5.27109 11.0195L6.43905 12.2281C6.49322 12.2857 6.53046 12.3771 6.5203 12.4922C6.50676 12.6615 6.49999 12.8307 6.49999 13C6.49999 13.1693 6.50676 13.3419 6.5203 13.5078C6.53046 13.6229 6.49322 13.7177 6.43905 13.7719L5.27109 14.9839C5.00364 15.2615 4.87499 15.6271 4.89192 15.9927C4.8953 16.0503 4.90885 16.1078 4.92916 16.162C5.06796 16.5174 5.23046 16.8594 5.41327 17.1911L5.41666 17.2013L5.56562 17.4586L5.569 17.4687C5.76874 17.8005 5.98879 18.1187 6.23254 18.4201C6.26978 18.4674 6.31379 18.5081 6.36458 18.5385C6.66926 18.7315 7.04843 18.8026 7.41744 18.7112L9.04921 18.3049C9.12369 18.2846 9.22525 18.3016 9.32004 18.3659C9.59765 18.5589 9.89218 18.7281 10.2003 18.8737C10.3052 18.9245 10.3661 19.0023 10.3898 19.0768L10.8536 20.6849C10.9586 21.0505 11.2091 21.3451 11.5307 21.5143C11.5849 21.5414 11.6391 21.5617 11.7 21.5685C12.1232 21.6328 12.5599 21.6667 13 21.6667C13.4401 21.6667 13.8768 21.6328 14.3 21.5685C14.3575 21.5583 14.4151 21.5414 14.4693 21.5143C14.7909 21.3484 15.0414 21.0539 15.1463 20.6849L15.6101 19.0701C15.6305 18.9956 15.6948 18.9177 15.7997 18.8669C16.1078 18.7214 16.4023 18.5487 16.6799 18.3591C16.7747 18.2948 16.8763 18.2779 16.9508 18.2982L18.5825 18.7044C18.9516 18.7958 19.3307 18.7281 19.6354 18.5318C19.6862 18.5013 19.7302 18.4607 19.7674 18.4133C20.0078 18.112 20.2279 17.7971 20.4276 17.4654L20.4344 17.4552L20.5833 17.1979L20.5867 17.1878C20.7695 16.8594 20.932 16.5141 21.0708 16.1586C21.0911 16.1044 21.1047 16.0469 21.1081 15.9893C21.125 15.6237 20.9963 15.2581 20.7289 14.9805L19.5609 13.7719C19.5068 13.7143 19.4695 13.6229 19.4797 13.5078C19.4932 13.3385 19.5 13.1693 19.5 13C19.5 12.8307 19.4932 12.6581 19.4797 12.4922C19.4695 12.3771 19.5068 12.2823 19.5609 12.2281L20.7289 11.0195C20.9963 10.7419 21.125 10.3763 21.1081 10.0107C21.1047 9.95312 21.0911 9.89557 21.0708 9.8414C20.932 9.48594 20.7695 9.14401 20.5867 8.81224L20.5833 8.80208L20.4344 8.54479L20.4276 8.53463C20.2279 8.20286 20.0078 7.88463 19.7674 7.58672C19.7302 7.53932 19.6862 7.4987 19.6354 7.46823C19.3307 7.27526 18.9516 7.20417 18.5825 7.29557L16.9508 7.70182C16.8763 7.72213 16.7747 7.70521 16.6799 7.64088C16.4023 7.44792 16.1078 7.27864 15.7997 7.13307C15.6948 7.08229 15.6338 7.00443 15.6101 6.92995L15.1463 5.3151C15.0414 4.94948 14.7909 4.65495 14.4693 4.48568C14.4151 4.45859 14.3609 4.43828 14.3 4.43151C13.8768 4.36719 13.4401 4.33333 13 4.33333ZM11.1042 13C11.1042 12.4972 11.3039 12.015 11.6594 11.6594C12.015 11.3039 12.4972 11.1042 13 11.1042C13.5028 11.1042 13.985 11.3039 14.3405 11.6594C14.6961 12.015 14.8958 12.4972 14.8958 13C14.8958 13.5028 14.6961 13.985 14.3405 14.3406C13.985 14.6961 13.5028 14.8958 13 14.8958C12.4972 14.8958 12.015 14.6961 11.6594 14.3406C11.3039 13.985 11.1042 13.5028 11.1042 13ZM15.9792 13C15.9792 12.2099 15.6653 11.4521 15.1066 10.8934C14.5479 10.3347 13.7901 10.0208 13 10.0208C12.2099 10.0208 11.4521 10.3347 10.8934 10.8934C10.3347 11.4521 10.0208 12.2099 10.0208 13C10.0208 13.7901 10.3347 14.5479 10.8934 15.1066C11.4521 15.6653 12.2099 15.9792 13 15.9792C13.7901 15.9792 14.5479 15.6653 15.1066 15.1066C15.6653 14.5479 15.9792 13.7901 15.9792 13Z" fill="#94A3B8"/>
        </svg>
      </button>
    </div>

    <!-- Error message -->
    <div v-if="error" class="error-message">
      {{ error }}
      <button @click="error = null" class="close-error">×</button>
    </div>

    <!-- Before room creation -->
    <div v-if="!roomData" class="initial-state">
      <button @click="createRoom" :disabled="loading" class="create-room-button">
        {{ loading ? '방 만드는 중...' : '방 만들기' }}
      </button>
    </div>

    <!-- After room creation -->
    <div v-else class="room-created-state">
      <div class="invite-section">
        <div class="invite-label">초대 코드</div>
        <div class="invite-code">{{ roomData.inviteCode }}</div>

        <div class="invite-label">초대 링크</div>
        <div class="invite-url">{{ inviteUrl }}</div>

        <CopyButton :text="inviteUrl" />
      </div>

      <div class="button-group">
        <button @click="openPanel" class="enter-button">
          입장하기
        </button>
        <button @click="leaveRoom" class="leave-button">
          나가기
        </button>
      </div>
    </div>
  </div>
</template>

<script lang="ts" setup>
import CopyButton from '@/components/CopyButton.vue'
import { roomController } from '@/components/RoomController'
import type { RoomResponse } from '@/components/dto/RoomResponse'
import { generateUUID } from '@/components/utils/uuid'
import { ref } from "vue"
import { MessageType } from "@/core/MessageType"
import { storageManager } from '@/core/StorageManager'
import {openSettings} from "@/core/OptionsUtils";

const roomData = ref<RoomResponse | null>(null)
const inviteUrl = ref<string>('')
const loading = ref<boolean>(false)
const error = ref<string | null>(null)

// Check if there's a pending join or existing room on mount
onMounted(async () => {
  const sessionData = await storageManager.getSessionData()

  // 방에 입장 중이거나 pendingJoin이 있으면 초대 코드 표시
  if (sessionData.roomId && sessionData.inviteCode) {
    // Set room data to show the invite code
    roomData.value = {
      roomId: sessionData.roomId,
      inviteCode: sessionData.inviteCode,
      currentVideoUrl: sessionData.currentVideoUrl || '',
      currentTime: 0,
      isPlaying: false
    } as RoomResponse

    inviteUrl.value = `http://localhost:8080/join?inviteCode=${sessionData.inviteCode}`

    // pendingJoin이 있으면 자동으로 패널 열기
    if (sessionData.pendingJoin) {
      // Clear the pending flag and badge
      await storageManager.removeItem('session:pendingJoin')
      await browser.action.setBadgeText({ text: '' })

      console.log('Auto-joining room:', sessionData.inviteCode)
      await openPanel()
    } else {
      console.log('Room already joined:', sessionData.inviteCode)
    }
  }
})

const createRoom = async () => {
  loading.value = true
  error.value = null

  try {
    // Get current active tab URL
    const tabs = await browser.tabs.query({ active: true, currentWindow: true })
    const currentUrl = tabs[0]?.url || ''

    console.log('Current tab URL:', currentUrl)

    const hostId = generateUUID()
    const response = await roomController.createRoom(hostId, currentUrl)

    // Store in session storage
    await storageManager.setSessionData({
      roomId: response.roomId,
      inviteCode: response.inviteCode,
      userId: hostId,
      isHost: true,
      currentVideoUrl: currentUrl
    })

    roomData.value = response
    inviteUrl.value = `http://localhost:8080/join?inviteCode=${response.inviteCode}`
    // inviteUrl.value = `https://syncparty.com/join?code=${response.inviteCode}`
  } catch (err) {
    console.error('방 생성 실패:', err)
    error.value = '방 생성에 실패했습니다. 다시 시도해주세요.'
  } finally {
    loading.value = false
  }
}

const openPanel = async () => {
  // Get current active tab
  const tabs = await browser.tabs.query({ active: true, currentWindow: true })
  const tabId = tabs[0]?.id

  if (!tabId) {
    console.error('No active tab found')
    return
  }

  browser.runtime.sendMessage({
    type: MessageType.OPEN_PANEL,
    tabId: tabId
  })

  // Popup 닫기
  window.close()
}

const leaveRoom = async () => {
  try {
    // 세션 데이터 삭제
    await storageManager.clearSessionData()

    // 상태 초기화
    roomData.value = null
    inviteUrl.value = ''

    console.log('방을 나갔습니다')
  } catch (err) {
    console.error('방 나가기 실패:', err)
    error.value = '방 나가기에 실패했습니다.'
  }
}
</script>

<style scoped>
.popup-container {
  width: 400px;
  min-height: 500px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.header {
  text-align: center;
}

.header h1 {
  margin: 0;
  font-size: 2em;
  color: #646cff;
  font-weight: 600;
}

.subtitle {
  margin: 8px 0 0 0;
  color: rgba(255, 255, 255, 0.6);
  font-size: 0.9em;
}

.error-message {
  background-color: #ff4444;
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.9em;
}

.close-error {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.5em;
  padding: 0;
  width: 24px;
  height: 24px;
  cursor: pointer;
  line-height: 1;
}

.close-error:hover {
  opacity: 0.8;
}

.initial-state {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

.create-room-button {
  background-color: #646cff;
  color: white;
  border: none;
  padding: 16px 48px;
  font-size: 1.1em;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s;
  font-weight: 600;
}

.create-room-button:hover:not(:disabled) {
  background-color: #535bf2;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(100, 108, 255, 0.4);
}

.create-room-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.room-created-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.invite-section {
  background-color: #1a1a1a;
  padding: 20px;
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.invite-label {
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.6);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.invite-code {
  font-size: 1.5em;
  font-weight: 700;
  color: #646cff;
  font-family: 'Courier New', monospace;
  letter-spacing: 2px;
}

.invite-url {
  font-size: 0.85em;
  color: rgba(255, 255, 255, 0.87);
  word-break: break-all;
  padding: 8px;
  background-color: #242424;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
}

.enter-button {
  background-color: #1a1a1a;
  color: rgba(255, 255, 255, 0.87);
  border: 2px solid #646cff;
  padding: 16px 48px;
  font-size: 1.1em;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s;
  font-weight: 600;
  margin-top: auto;
}

.enter-button:hover {
  background-color: #646cff;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(100, 108, 255, 0.4);
}

.button-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: auto;
}

.leave-button {
  background-color: transparent;
  color: rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 12px 24px;
  font-size: 0.95em;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.25s;
  font-weight: 500;
}

.leave-button:hover {
  background-color: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.4);
  color: rgba(255, 255, 255, 0.87);
}
</style>
